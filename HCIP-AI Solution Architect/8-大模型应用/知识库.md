#RAG
# 知识库的概念 
## 什么是知识库
知识库就是用户利用知识管理软件创建一个集中式存储库，该存储库可用于轻松创建、组织、查找和共享知识，将分散在各处的知识集中起来。其结构可以帮助员工或客户找到问题或疑虑的答案
## 知识库的价值 
知识库的应用范围广泛，例如智能客服系统、搜索引擎、语音识别、自然语言处理、机器翻译等领域。
## 大模型与知识库的关系
大模型的训练数据，是公开而普世的知识数据，当你问它你的企业、或者某个领域非常专业的问题时，它无法给出准确的回答。知识库相当于Agent的“外部资料库”，当被问到不懂的问题时，Agent先去知识库里查询一番，根据查询出的内容，自己总结以后再回答给你

# 大模型搜索增强 
## RAG
#### 什么是 RAG 
RAG（Retrieval Augmented Generation，检索增强生成），即LLM在回答问题或生成文本时， 先会从大量文档中检索出相关的信息，然后基于这些信息生成回答或文本，从而提高预测质量
在LLM已经具备了较强能力的基础上，仍然存在以下问题：
- 幻觉问题：LLM文本生成的底层原理是基于概率的token by token的形式，因此会不可避免地产生“一本正经的胡说八道”的情况；
- 时效性问题：LLM的规模越大，大模型训练的成本越高，周期也就越长。那么具有时效性的数据也就无法参与训练，所以也就无法直接回答时效性相关的问题，例如“帮我推荐几部热映的电影？”；
- 数据安全问题：通用的LLM没有企业内部数据和用户数据，那么企业想要在保证安全的前提下使用LLM，最好的方式就是把数据全部放在本地，企业数据的业务计算全部在本地完成
#### 使用RAG的好处
- 可扩展性（Scalability）：减少模型大小和训练成本，并允许轻松扩展知识。 
- 准确性（Accuracy)：通过引用信息来源，用户可以核实答案的准确性，这增强了人们对模型输出结果的信任。 
- 可控性（Controllability）：允许更新或定制知识。 
- 可解释性（Interpretability）：检索到的项目作为模型预测中来源的参考。 
- 多功能性（Versatility）：RAG可以针对多种任务进行微调和定制，包括Q&A、文本摘要、对话系统等。 
- 及时性：使用检索技术能识别到最新的信息，这使RAG在保持回答的及时性和准确性方面，相较于只依赖训练数据的传统语言模型有明显优势。 
- 定制性：通过索引与特定领域相关的文本语料库，RAG能够为不同领域提供专业的知识支持。 
- 安全性：RAG通过数据库中设置的角色和安全控制，实现了对数据使用的更好控制。相比之下，经过微调的模型在管理数据访问权限方面可能不够明确
#### RAG典型实现方法
![[HCIP-AI Solution Architect V1.0 培训教材.pdf#page=589&rect=105,449,452,641&color=red|HCIP-AI Solution Architect V1.0 培训教材, p.589|500]]
## 数据索引
#### 数据提取
- 数据获取: 包括多格式数据（PDF、word、markdown以及数据库和API等）加载、不同数据源获取等，根据数据自身情况，将数据处理为同一个范式
- 数据清洗：对源数据进行去重、过滤、压缩和格式化等处理； 
- 信息提取：提提取数据中关键信息，包括文件名、时间、章节title、图片等信息。
#### 向量化及创建索引
- 向量化（embedding）：将文本、图像、音频和视频等转化为向量矩阵的过程，也就是变成计算机可以理解的格式。 
- 创建索引：数据向量化后构建索引，并写入数据库的过程可以概述为数据入库过程。
#### 检索 
检索技术：检索的主要方式还是这几种： 
- 向量化（embedding）相似度检索：相似度计算方式包括欧氏距离、曼哈顿距离、余弦等。 
- 重排序（Rerank）：相关度、匹配度等因素做一些重新调整，得到更符合业务场景的排序。 
- 查询轮换：这是查询检索的一种方式，一般会有几种方式： 
	- 子查询：可以在不同的场景中使用各种查询策略，比如树查询（从叶子结点，一步步查询，合并）， 向量查询，或者最原始的顺序查询chunks等； 
	- HyDE：这是一种抄作业的方式，生成相似的或者更标准的prompt模板。
## RAG评估方法 
目前主要有两种方法来评估RAG的有效性：独立评估和端到端评估

# 以LangChain为核心的知识库生成构建 

## 什么是LangChain
LangChain是一个用于构建基于语言模型的应用程序的框架。它提供了一系列工具和功能， 帮助开发者更方便地利用大语言模型（如GPT-4）来创建各种复杂的自然语言处理任务
#### 模型
LangChain model是一种抽象，表示框架中使用的不同类型的模型。LangChain中的模型主要分为三类： 
- LLM（大型语言模型）：这些模型将文本字符串作为输入并返回文本字符串作为输出。它们是许多语言模型应用程序的支柱。 
- 聊天模型（Chat Model）：聊天模型由语言模型支持，但具有更结构化的API。他们将聊天消息列表作为输入并返回聊天消息。这使得管理对话历史记录和维护上下文变得容易。 
- 文本嵌入模型（Text Embedding Models）：这些模型将文本作为输入并返回表示文本嵌入的浮点列表。这些嵌入可用于文档检索、聚类和相似性比较等任务。
#### 提示 
Prompt指的是模型生成内容时所需要的输入，它可以包含模型生成内容时所需要的背景知识、用户期望模型执行的指令、模型输出需要遵循的格式等。在LangChain中的Prompts 有三个部分：Prompt Templates，Output Parsers和Example Selectors。 
- Prompt Template支持你通过一个模板生成一个对应的Prompt。 
- Output Parsers的主要作用是将LLM的文本解析为结构化的数据。 
- Example Selector就是负责帮助你构建一个Few-shot的Prompt。
#### 记忆 
在LangChain中，Memory指的是大语言模型（LLM）的**短期记忆**。为什么是短期记忆？
那是因为LLM训练好之后（获得了一些长期记忆），它的参数便不会因为用户的输入而发生改变。当用户与训练好的LLM进行对话时，LLM会暂时记住用户的输入和它已经生成的输出，以便预测之后的输出，而模型输出完毕后，它便会“遗忘”之前用户的输入和它的输出。因此，之前的这些信息只能称作为LLM的短期记忆
#### 链 
我们可以把链理解为任务。一个链就是一个任务，当然也可以像链条一样，一个一个的执行多个链
![[HCIP-AI Solution Architect V1.0 培训教材.pdf#page=599&rect=98,478,455,595&color=yellow|HCIP-AI Solution Architect V1.0 培训教材, p.599]]
#### 代理 
我们可以简单的理解为它可以动态地帮我们选择和调用chain或者已有的工具
![[HCIP-AI Solution Architect V1.0 培训教材.pdf#page=600&rect=67,451,485,617&color=yellow|HCIP-AI Solution Architect V1.0 培训教材, p.600]]
#### 索引 
索引组件为LangChain提供了文档处理的能力，包括文档加载、检索等等，这里的文档是广义的文档
索引组件主要有以下四种类型： 
- 文档加载器。 
- 文本分割器。 
- VectorStores。 
- 检索器。
## LangChain中基于文档的问答
检索问答链（Retrieval Q&A Chain） 检索问答链是LangChain框架中的一个具体实现，它覆盖了实现RAG（检索增强生成）的全部流程。通过检索问答链，开发者能够轻松地构建与问答相关的应用，该链使用RAG的方法结合检索模块，从外部知识库中检索相关信息，然后生成答案。
## 基于LangChain搭建RAG应用
## 建向量数据库 
这个流程主要涉及加载源文件、文档分块和文档向量化： 
- 加载源文件：确定源文件类型，选择加载器。 
- 文档分块：切分文档，手动控制分割。 
- 文档向量化：选择向量化模型，向量化过程，存储向量。
## 向量数据库 
向量数据库主要用于图像检索、音频检索、文本检索等领域，其主要特点是能够高效地存储和检索大规模的向量数据
## 文件导入 
以下是简单的 Python 代码 ，我们可以可到通过引入了 langchain 的document_loaders的 module，就实现了对用户的“SQL基础教程.pdf”文件的入库。同理，通过工程化可以实现文件批量导入。
## 文件分割 
同样使用Langchain来实现，可按照字符数量长度等一系列参数进行分割
## 知识库向量化
取得分割后的文档，我们需要将其向量化，也就是NLP领域常见的Embedding。
每个文档向量化以后，我们将采用数据库将这些结果存起来。这里我们使用一款名为 Chroma的轻量级向量数据库，LangChain也集成了这个数据库方便使用
## 检索向量化
## 提交LLM生成答案
# 知识库查询的挑战与发展方向
## RAG当前的挑战 
RAG方案是一个领域知识问答的整体架构，真正应用时还是会面临非常多的挑战，因为领域知识问答对回答的准确性、完整性有着非常高的要求
## RAG的发展趋势
![[HCIP-AI Solution Architect V1.0 培训教材.pdf#page=615&rect=86,478,441,630&color=yellow|HCIP-AI Solution Architect V1.0 培训教材, p.615]]
